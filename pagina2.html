<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITC-PEDIA</title>
    <!-- PDF.js para procesamiento de PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        
        body {
            background: #fbfbfd;
            color: #1d1d1f;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
            padding-top: 65px;
            font-feature-settings: 'kern';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.022em;
            line-height: 1.47059;
        }
        nav {
            position: fixed;
            top: 0;
            width: 100%;
            background: #ff0000;
            z-index: 1000;
            transition: all 0.28s cubic-bezier(0.4, 0, 0.6, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 2rem;
            background: transparent;
            flex-wrap: nowrap;
            min-height: 45px;
        }
        .logo {
            height: 1.8rem !important;
            width: auto;
            display: block;
        }
        .nav-links {
            display: flex;
            list-style: none;
            gap: 1.5rem;
            flex-wrap: nowrap;
            align-items: center;
        }
        .nav-links a {
            color: #fff;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.28s cubic-bezier(0.4, 0, 0.6, 1);
            position: relative;
            font-size: 13px;
            padding: 8px 12px;
            border-radius: 20px;
            letter-spacing: -0.01em;
            line-height: 1.33337;
        }
        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.02);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        #user-info {
            color: #fff;
            font-weight: 500;
            font-size: 12px;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: -0.01em;
            opacity: 0.95;
        }

        /* Main content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: clamp(22px, 5vw, 44px);
        }
        .title {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 1rem;
            color: #ff0000;
            letter-spacing: -0.035em;
            line-height: 1.05;
        }
        .subtitle {
            font-size: 1.25rem;
            font-weight: 400;
            margin-bottom: 2rem;
            color: #86868b;
            letter-spacing: -0.022em;
            line-height: 1.381;
            max-width: 600px;
        }
        .mode-toggle {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            justify-content: center;
        }
        .toggle-btn {
            background: rgba(251, 251, 253, 0.8);
            color: #1d1d1f;
            border: 1px solid rgba(174, 174, 178, 0.5);
            padding: 11px 22px;
            border-radius: 22px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            letter-spacing: -0.01em;
            transition: all 0.28s cubic-bezier(0.4, 0, 0.6, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .toggle-btn.active,
        .toggle-btn:hover {
            background: #ff0000;
            color: #fff;
            border-color: transparent;
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(255, 0, 0, 0.25);
        }
        .admin-panel {
            background: rgba(251, 251, 253, 0.88);
            padding: clamp(22px, 5vw, 44px);
            border-radius: 22px;
            margin-bottom: 32px;
            display: none;
            border: 1px solid rgba(174, 174, 178, 0.16);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.08);
        }
        .admin-panel h2 {
            margin-bottom: 24px;
            color: #1d1d1f;
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: -0.022em;
            line-height: 1.2;
        }
        .upload-area {
            border: 2px dashed rgba(174, 174, 178, 0.48);
            border-radius: 22px;
            padding: clamp(32px, 8vw, 64px);
            text-align: center;
            margin-bottom: 24px;
            background: rgba(255, 255, 255, 0.6);
            transition: all 0.28s cubic-bezier(0.4, 0, 0.6, 1);
            color: #1d1d1f;
            cursor: pointer;
            position: relative;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .upload-area:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: #ff0000;
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(255, 0, 0, 0.15);
        }
        .upload-area.dragover {
            background: #e8f5e8;
            border-color: #4caf50;
            color: #4caf50;
        }
        .upload-area.processing {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .upload-area.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .upload-icon {
            font-size: 3.5rem;
            margin-bottom: 16px;
            opacity: 0.6;
        }
        .upload-text {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }
        .upload-subtext {
            font-size: 14px;
            color: #86868b;
            letter-spacing: -0.01em;
        }
        .form-group {
            margin-bottom: 22px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1d1d1f;
            font-size: 14px;
            letter-spacing: -0.01em;
        }
        .form-input, .form-textarea, select.form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(174, 174, 178, 0.48);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: #1d1d1f;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.28s cubic-bezier(0.4, 0, 0.6, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .form-input:focus, .form-textarea:focus, select.form-input:focus {
            border-color: #ff0000;
            outline: none;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 4px rgba(255, 0, 0, 0.1);
        }
        .btn-primary {
            background: #ff0000;
            color: #fff;
            border: none;
            padding: 14px 28px;
            border-radius: 22px;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
            letter-spacing: -0.01em;
            transition: all 0.28s cubic-bezier(0.4, 0, 0.6, 1);
            box-shadow: 0 4px 16px rgba(255, 0, 0, 0.25);
        }
        .btn-primary:hover {
            background: #d70000;
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(255, 0, 0, 0.35);
        }
        .btn-secondary {
            background: rgba(251, 251, 253, 0.88);
            color: #1d1d1f;
            border: 1px solid rgba(174, 174, 178, 0.48);
            padding: 14px 28px;
            border-radius: 22px;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
            letter-spacing: -0.01em;
            transition: all 0.28s cubic-bezier(0.4, 0, 0.6, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .btn-secondary:hover {
            background: #ff0000;
            color: #fff;
            border-color: transparent;
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(255, 0, 0, 0.25);
        }
        
        /* Biblioteca de Instructivos */
        .instructivos-library {
            margin-bottom: 32px;
        }
        .library-header {
            text-align: center;
            margin-bottom: 32px;
            padding: clamp(32px, 8vw, 48px);
            background: rgba(251, 251, 253, 0.88);
            border-radius: 22px;
            border: 1px solid rgba(174, 174, 178, 0.16);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.08);
        }
        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }
        .search-bar {
            margin-bottom: 24px;
        }
        .search-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(174, 174, 178, 0.48);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: #1d1d1f;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.28s cubic-bezier(0.4, 0, 0.6, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .search-input:focus {
            border-color: #ff0000;
            outline: none;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 4px rgba(255, 0, 0, 0.1);
        }
        .instructivos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }
        .instructivo-card {
            background: rgba(251, 251, 253, 0.88);
            border-radius: 22px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.28s cubic-bezier(0.4, 0, 0.6, 1);
            border: 1px solid rgba(174, 174, 178, 0.16);
            color: #1d1d1f;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.08);
        }
        .instructivo-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 48px rgba(31, 38, 135, 0.16);
            background: rgba(255, 255, 255, 0.95);
        }
        .instructivo-icon {
            margin-bottom: 16px;
            text-align: center;
            background: #ff0000;
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(255, 0, 0, 0.2);
            width: 64px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px auto;
            box-shadow: 0 4px 16px rgba(255, 0, 0, 0.25);
        }
        .instructivo-icon img {
            width: 100%;
            height: auto;
            max-height: 100%;
            filter: brightness(0) invert(1);
            object-fit: contain;
        }
        .instructivo-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1d1d1f;
            line-height: 1.25;
            letter-spacing: -0.01em;
        }
        .instructivo-description {
            font-size: 15px;
            margin-bottom: 16px;
            color: #86868b;
            line-height: 1.47059;
            letter-spacing: -0.022em;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .instructivo-category {
            display: inline-block;
            background: #ff0000;
            color: white;
            font-size: 11px;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 16px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            margin-right: 8px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(255, 0, 0, 0.2);
        }

        .instructivo-category.empty {
            background: rgba(174, 174, 178, 0.3);
            color: #86868b;
            box-shadow: none;
        }

        .instructivo-group {
            display: inline-block;
            background: #28a745;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.8rem;
        }

        .instructivo-group.empty {
            background: #e9ecef;
            color: #6c757d;
        }

        .instructivo-badges {
            margin-bottom: 0.8rem;
        }
        .instructivo-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #777;
            border-top: 1px solid #f0f0f0;
            padding-top: 0.8rem;
        }
        .instructivo-date {
            color: #999;
        }
        .instructivo-words {
            background: #fff5f5;
            color: #b80000;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }
        
        /* Visor de Instructivos */
        .instructivo-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Icons", "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: "kern" 1, "liga" 1, "calt" 1;
            font-optical-sizing: auto;
        }
        .viewer-header {
            background: #ff0000;
            color: #fff;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .viewer-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .instructivo-content {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            max-width: 100%;
            margin: 0;
            width: 100%;
            box-sizing: border-box;
            background: #ffffff;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        
        /* Contenedor interno para el contenido */
        .instructivo-content > div {
            max-width: 900px;
            margin: 0 auto;
            padding: 3rem 2.5rem;
            line-height: 1.6;
            color: #1d1d1f;
            font-size: 16px;
            font-weight: 400;
            letter-spacing: -0.022em;
        }
        .close-viewer {
            background: rgba(255,255,255,0.15);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .close-viewer:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.4);
            transform: translateY(-1px);
        }
        
        /* Estructura del visor con índice */
        .viewer-body {
            display: flex;
            flex: 1;
            height: calc(100% - 80px);
        }
        
        /* Tabla de contenido */
        .table-of-contents {
            width: 280px;
            background: #f8f9fa;
            border-right: 1px solid #e1e5e9;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            overflow: hidden;
            opacity: 0;
            animation: fadeInTOC 0.3s ease forwards;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Icons", "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: "kern" 1, "liga" 1;
        }
        
        @keyframes fadeInTOC {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .table-of-contents.collapsed {
            width: 0;
            opacity: 0;
        }
        .toc-header {
            padding: 1.5rem 1.25rem 1rem 1.25rem;
            background: #ffffff;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toc-header h4 {
            margin: 0;
            color: #1d1d1f;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.025em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.2;
        }
        .toc-toggle {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #6e6e73;
            padding: 0.4rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        .toc-toggle:hover {
            background: #f5f5f7;
            color: #ff0000;
        }
        .toc-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem 0;
        }
        
        /* Scrollbar personalizado para el índice con mejor calidad */
        .toc-content::-webkit-scrollbar {
            width: 6px;
        }
        .toc-content::-webkit-scrollbar-track {
            background: #f5f5f7;
            border-radius: 3px;
        }
        .toc-content::-webkit-scrollbar-thumb {
            background: #d2d2d7;
            border-radius: 3px;
            border: 1px solid #f5f5f7;
        }
        .toc-content::-webkit-scrollbar-thumb:hover {
            background: #a1a1a6;
        }
        
        .toc-item {
            display: block;
            padding: 0.7rem 1.25rem;
            color: #6e6e73;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
            font-size: 14px;
            line-height: 1.42857;
            font-weight: 400;
            border-bottom: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: -0.016em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        .toc-item:hover {
            background: #f5f5f7;
            color: #1d1d1f;
            border-left-color: #ff0000;
            text-decoration: none;
        }
        .toc-item.active {
            background: #f0f0f0;
            color: #ff0000;
            border-left-color: #ff0000;
            font-weight: 600;
        }
        .toc-item.level-1 {
            padding-left: 1.25rem;
            font-weight: 600;
            font-size: 15px;
            color: #1d1d1f;
            line-height: 1.33333;
            letter-spacing: -0.022em;
        }
        .toc-item.level-2 {
            padding-left: 2rem;
            font-size: 14px;
            color: #424245;
            line-height: 1.42857;
            letter-spacing: -0.018em;
        }
        .toc-item.level-3 {
            padding-left: 2.75rem;
            font-size: 13px;
            color: #6e6e73;
            line-height: 1.46154;
            letter-spacing: -0.016em;
        }
        .toc-item.level-4,
        .toc-item.level-5,
        .toc-item.level-6 {
            padding-left: 3.5rem;
            font-size: 12px;
            color: #8e8e93;
            line-height: 1.5;
            letter-spacing: -0.014em;
        }
        
        /* Estilos mejorados para el contenido del visor */
        .instructivo-content h1:first-child {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Icons", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 32px; /* Mismo tamaño que otros h1 */
            font-weight: 600;
            color: #ff0000 !important; /* Color rojo ITC para todos los h1 */
            margin-top: 0;
            margin-bottom: 2.5rem;
            letter-spacing: -0.025em;
            line-height: 1.0625; /* Mismo line-height que otros h1 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: "kern" 1, "liga" 1;
            border-bottom: 2px solid #ff0000; /* Línea roja divisoria */
            padding-bottom: 0.5rem;
        }
        
        .instructivo-content h1,
        .instructivo-content h2,
        .instructivo-content h3,
        .instructivo-content h4,
        .instructivo-content h5,
        .instructivo-content h6 {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Icons", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-weight: 600;
            letter-spacing: -0.025em;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            color: #1d1d1f;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: "kern" 1, "liga" 1;
        }
        
        .instructivo-content h1:not(:first-child) {
            font-size: 32px;
            line-height: 1.0625;
            margin-bottom: 1.5rem;
            color: #ff0000 !important; /* Color rojo ITC */
            font-weight: 600;
            border-bottom: 2px solid #ff0000; /* Línea roja divisoria */
            padding-bottom: 0.5rem;
        }
        
        .instructivo-content h2 {
            font-size: 24px;
            line-height: 1.16667;
            margin-top: 2rem;
        }
        
        .instructivo-content h3 {
            font-size: 20px;
            line-height: 1.2;
            margin-top: 1.5rem;
        }
        
        .instructivo-content h4 {
            font-size: 18px;
            line-height: 1.22222;
        }
        
        .instructivo-content p {
            margin-bottom: 1rem;
            line-height: 1.47059;
            color: #1d1d1f;
            font-size: 17px;
            font-weight: 400;
            letter-spacing: -0.022em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        
        .instructivo-content ul,
        .instructivo-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
            color: #1d1d1f;
            font-size: 17px;
            line-height: 1.47059;
            letter-spacing: -0.022em;
        }
        
        .instructivo-content li {
            margin-bottom: 0.5rem;
            line-height: 1.47059;
        }
        
        .instructivo-content img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin: 2rem 0;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            border: 1px solid #e5e5e7;
        }
        
        .instructivo-content blockquote {
            border-left: 4px solid #ff0000;
            margin: 2rem 0;
            padding: 1.5rem 2rem;
            background: #f8f9fa;
            border-radius: 0 12px 12px 0;
            font-style: italic;
            color: #424245;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        
        .instructivo-content code {
            background: #f5f5f7;
            color: #1d1d1f;
            padding: 0.3rem 0.5rem;
            border-radius: 6px;
            font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
            font-size: 0.9em;
            font-weight: 500;
            border: 1px solid rgba(0,0,0,0.04);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Estilos conservadores para elementos vacíos - solo ocultar elementos realmente problemáticos */
        .instructivo-content p:empty:not(:has(img)):not(:has(video)):not(:has(iframe)) {
            display: none;
        }
        
        .instructivo-content pre {
            background: #f5f5f7;
            border-radius: 12px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 2rem 0;
            border: 1px solid #e5e5e7;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        
        .instructivo-content pre code {
            background: none;
            padding: 0;
            border: none;
            font-size: 0.95em;
        }
        
        .instructivo-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            border: 1px solid #e5e5e7;
        }
        
        .instructivo-content th,
        .instructivo-content td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #e5e5e7;
            font-size: 16px;
            line-height: 1.47059;
        }
        
        .instructivo-content th {
            background: #f8f9fa;
            font-weight: 600;
            color: #1d1d1f;
            font-size: 15px;
            letter-spacing: -0.024em;
        }
        
        .instructivo-content td {
            color: #1d1d1f;
            letter-spacing: -0.022em;
        }
        
        /* Ajustes al contenido principal */
        .instructivo-content {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            box-sizing: border-box;
            max-width: 100%;
            margin: 0;
            width: 100%;
            background: #ffffff;
        }
        
        /* Wrapper para centrar y dar padding al contenido */
        .instructivo-content > * {
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            padding-left: 2.5rem;
            padding-right: 2.5rem;
        }
        
        .instructivo-content > *:first-child {
            padding-top: 3rem;
        }
        
        .instructivo-content > *:last-child {
            padding-bottom: 3rem;
        }
        
        /* Scrollbar personalizado para mejor calidad visual */
        .instructivo-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .instructivo-content::-webkit-scrollbar-track {
            background: #f5f5f7;
            border-radius: 4px;
        }
        
        .instructivo-content::-webkit-scrollbar-thumb {
            background: #d2d2d7;
            border-radius: 4px;
            border: 1px solid #f5f5f7;
        }
        
        .instructivo-content::-webkit-scrollbar-thumb:hover {
            background: #a1a1a6;
        }
        
        /* Optimizaciones para pantallas de alta resolución */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .instructivo-content {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
                will-change: scroll-position;
            }
            
            .instructivo-content h1:first-child,
            .instructivo-content h1,
            .instructivo-content h2,
            .instructivo-content h3,
            .instructivo-content h4,
            .instructivo-content p {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }
            
            .table-of-contents {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }
            
            .toc-header h4,
            .toc-item {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }
        }
        
        .admin-controls {
            margin-top: 1rem;
        }
        .btn-danger {
            background: #ff0000;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        .btn-danger:hover {
            background: #b80000;
        }

        /* Tema oscuro automático */
        @media (prefers-color-scheme: dark) {
            body {
                background: #181818;
                color: #fff;
            }
            nav {
                background: linear-gradient(90deg, #b80000 0%, #ff0000 100%);
                box-shadow: 0 2px 8px 0 #222;
            }
            .nav-links a {
                color: #fff;
            }
            .nav-links a:hover {
                color: #ffb3b3;
            }
            #user-info {
                color: #fff;
            }
            .main-content {
                background: #181818;
                color: #fff;
            }
            .title {
                color: #ffffff;
            }
            .subtitle {
                color: #ccc;
            }
            .toggle-btn {
                background: #181818;
                color: #ffb3b3;
                border: 2px solid #ff4d4d;
            }
            .toggle-btn.active,
            .toggle-btn:hover {
                background: linear-gradient(90deg, #b80000 0%, #ff0000 100%);
                color: #fff;
                border-color: #ff0000;
            }
            .admin-panel {
                background: #222;
                color: #fff;
                border: 1px solid #333;
            }
            .admin-panel h2 {
                color: #ffffff;
            }
            .upload-area {
                background: #222;
                color: #ffffff;
                border-color: #ffffff;
            }
            .upload-area:hover {
                background: #2a0000;
            }
            .upload-subtext {
                color: #ffb3b3;
            }
            .form-label {
                color: #ff4d4d;
            }
            .form-input, .form-textarea, select.form-input {
                background: #181818;
                color: #fff;
                border: 1px solid #ff4d4d;
            }
            .form-input:focus, .form-textarea:focus, select.form-input:focus {
                border-color: #dddddd;
            }
            .btn-primary {
                background: linear-gradient(90deg, #b80000 0%, #ff0000 100%);
                color: #fff;
            }
            .btn-primary:hover {
                background: #ff0000;
            }
            .btn-secondary {
                background: #181818;
                color: #ffb3b3;
                border: 2px solid #ff4d4d;
            }
            .btn-secondary:hover {
                background: #ffffff;
                color: #fff;
            }
            .pdf-library {
                background: #181818;
            }
            .search-input {
                background: #222;
                color: #fff;
                border: 1px solid #ff4d4d;
            }
            .search-input:focus {
                border-color: #ff0000;
            }
            .pdf-card {
                background: #222;
                color: #fff;
                border: 1px solid #333;
            }
            .pdf-card:hover {
                background: #2a0000;
            }
            .pdf-icon,
            .pdf-title,
            .pdf-meta,
            .pdf-category {
                color: #ff4d4d;
            }
            .pdf-description {
                color: #ccc;
            }
            .empty-state {
                background: #222;
                color: #ff4d4d;
                border: 1px solid #333;
            }
            .empty-icon {
                color: #ffffff;
            }
            .btn-danger {
                background: #b80000;
                color: #fff;
            }
            .btn-danger:hover {
                background: #ff0000;
            }
            /* PDF Viewer nativo */
            #pdf-viewer-container {
                background: #181818 !important;
            }
            .viewer-header {
                background: linear-gradient(90deg, #b80000 0%, #ff0000 100%);
                color: #fff;
                border-bottom: 1px solid #ff4d4d;
            }
            #viewerTitleNative {
                color: #fff;
            }
            #closeViewerBtnNative {
                background: #b80000;
                color: #fff;
            }
            #closeViewerBtnNative:hover {
                background: #ffffff;
            }
        }

        #pdfViewer {
            display: none !important;
        }

        /* Recuadro gris */
        .hero-box,
        .admin-panel {
            background: #ededed;
            border-radius: 18px;
            padding: 2.5rem 2rem 2rem 2rem;
            margin-bottom: 2.5rem;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.04);
            border: none;
        }

        /* Tema oscuro */
        @media (prefers-color-scheme: dark) {
            .hero-box,
            .admin-panel {
                background: #232323;
                color: #fff;
                border: none;
            }
            .instructivos-library {
                background: #181818;
            }
            .library-header {
                background: linear-gradient(135deg, #2a0000 0%, #181818 100%);
                border-color: #333;
                color: #fff;
            }
            .instructivo-card {
                background: #222;
                color: #fff;
                border-color: #333;
            }
            .instructivo-card:hover {
                background: #2a0000;
                border-color: #ff0000;
            }
            .instructivo-content {
                background: #181818;
                color: #fff;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-container {
                padding: 12px 16px;
            }
            .nav-links {
                gap: 12px;
                font-size: 12px;
            }
            .nav-links a {
                padding: 6px 10px;
                white-space: nowrap;
            }
            .logo {
                height: 1.6rem !important;
            }
            #user-info {
                font-size: 11px;
            }
            .main-content {
                padding: 16px;
            }
            .instructivos-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            .library-header {
                padding: 24px 16px;
            }
            .instructivo-viewer {
                padding: 0;
            }
            .instructivo-content > * {
                padding-left: 2rem;
                padding-right: 2rem;
            }
            .instructivo-content > *:first-child {
                padding-top: 2.5rem;
            }
            .instructivo-content > *:last-child {
                padding-bottom: 2.5rem;
            }
            .viewer-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            .viewer-actions {
                justify-content: center;
            }
            .table-of-contents {
                width: 260px;
            }
            .viewer-body {
                flex-direction: column;
            }
            .table-of-contents {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #e1e5e9;
                max-height: 200px;
            }
            .instructivo-content h1 {
                font-size: clamp(24px, 6vw, 32px);
            }
            .instructivo-content h2 {
                font-size: clamp(20px, 5vw, 28px);
            }
            .instructivo-content h3 {
                font-size: clamp(18px, 4vw, 24px);
            }
        }

        @media (max-width: 480px) {
            .nav-container {
                padding: 8px 12px;
                flex-wrap: nowrap;
            }
            .nav-links {
                gap: 8px;
                font-size: 0.75rem;
                flex-wrap: nowrap;
                overflow-x: auto;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .nav-links::-webkit-scrollbar {
                display: none;
            }
            .nav-links a {
                padding: 0.2rem 0.4rem;
                white-space: nowrap;
                min-width: fit-content;
            }
            .logo {
                height: 1.5rem !important;
                flex-shrink: 0;
            }
            #user-info {
                font-size: 0.75rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 80px;
            }
            #logout-btn {
                font-size: 0.7rem !important;
                padding: 0.2rem 0.5rem !important;
                flex-shrink: 0;
            }
            .instructivo-card {
                padding: 1rem;
            }
            .instructivo-title {
                font-size: 1.1rem;
            }
            /* Visor optimizado para móvil */
            .instructivo-content > * {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
            .instructivo-content > *:first-child {
                padding-top: 2rem;
            }
            .instructivo-content > *:last-child {
                padding-bottom: 2rem;
            }
            .instructivo-content h1:first-child {
                font-size: 24px;
                line-height: 1.16667;
            }
            .instructivo-content h1:not(:first-child) {
                font-size: 28px;
                line-height: 1.10714;
            }
            .instructivo-content h2 {
                font-size: 22px;
                line-height: 1.18182;
            }
            .instructivo-content h3 {
                font-size: 18px;
                line-height: 1.22222;
            }
            .instructivo-content p,
            .instructivo-content ul,
            .instructivo-content ol {
                font-size: 16px;
                line-height: 1.5;
            }
            .instructivo-content th,
            .instructivo-content td {
                padding: 12px 16px;
                font-size: 15px;
            }
            .viewer-header {
                padding: 0.75rem;
            }
            .close-viewer {
                padding: 0.5rem 0.8rem;
                font-size: 13px;
            }
            /* Ocultar tabla de contenido en pantallas muy pequeñas por defecto */
            .table-of-contents {
                display: none;
            }
            .table-of-contents.show-mobile {
                display: flex;
                height: 150px;
            }
            .action-buttons button {
                padding: 0.7rem 1rem;
                font-size: 0.9rem;
            }
        }

        /* Modal para editar imagen de tarjeta */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .image-modal-content {
            background: #fff;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .image-modal h3 {
            color: #ff0000;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .image-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-upload-area:hover {
            border-color: #ff0000;
            background: #fff5f5;
        }

        .image-upload-area.dragover {
            border-color: #ff0000;
            background: #fff5f5;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        .image-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 0.9rem;
            color: #666;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn-modal {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-modal.primary {
            background: #ff0000;
            color: #fff;
        }

        .btn-modal.primary:hover {
            background: #d32f2f;
        }

        .btn-modal.secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-modal.secondary:hover {
            background: #e9ecef;
        }

        /* Icono de editar en tarjetas */
        .instructivo-card {
            position: relative;
        }

        .card-edit-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 0, 0, 0.8);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }

        .instructivo-card:hover .card-edit-icon {
            opacity: 1;
        }

        .card-edit-icon:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <a href="index.html">
                    <img src="media/logotipo_ITC.svg" alt="ITC Logo" class="logo">
                </a>
                <span id="user-info" style="color: #fff; font-weight: 600; font-size: 0.9rem;"></span>
                <button id="logout-btn" style="display:none; margin-left: 0.3rem; padding: 0.3rem 0.8rem; border-radius: 15px; border: none; background: #ff1f1f; color: #fff; font-weight: 600; cursor: pointer; font-size: 0.8rem;">Salir</button>
            </div>
            <ul class="nav-links">
                <li><a href="editor-instructivos.html" data-admin-only>Editor Instructivos</a></li>
                <li><a href="https://sistema3.itc.com.ar/" target="_blank" rel="noopener">Sistema actividades</a></li>
                <li><a href="#">HubSpot</a></li>
                <li><a href="#">Speedtest</a></li>
                <li><a href="#">Smart OLT</a></li>
                <li><a href="#">WHM-hosting2</a></li>
                <li><a href="#">ping.eu</a></li>
                <li><a href="#">Blacklists</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="content-container">
            <!-- Recuadro gris -->
            <div class="hero-box">
                <h1 class="title">Biblioteca Digital<br>ITC-PEDIA Soporte Tecnico</h1>
                <p class="subtitle">
                    Accede a toda la documentación técnica, manuales, procedimientos y guías de la organización. 
                    Sistema centralizado para gestionar y consultar recursos digitales de forma eficiente y organizada.
                </p>
                <!-- Mode Toggle -->
                <div class="mode-toggle">
                    <button class="toggle-btn" id="btn-user-mode">Modo Usuario</button>
                    <button class="toggle-btn" id="btn-admin-mode">Modo Admin</button>
                    <button class="toggle-btn" onclick="window.location.href='editor-instructivos.html'" style="background: linear-gradient(90deg, #ff0000 0%, #b80000 100%); color: #fff; border-color: #ff0000;" data-admin-only>Editor Instructivos</button>
                </div>
            </div>
            <!-- Admin Panel -->
            <div class="admin-panel" id="adminPanel" data-admin-only>
                <h2 style="margin-bottom: 20px; color: #ff0000;">Panel de Administración</h2>
                <p style="color: #666; margin-bottom: 30px;">
                    Convierte documentos PDF existentes en instructivos editables. Los archivos se procesarán y 
                    se crearán como instructivos que podrás editar posteriormente con el editor avanzado.
                </p>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">PDF → DOC</div>
                    <div class="upload-text">Arrastra tu archivo PDF para convertir a instructivo</div>
                    <div class="upload-subtext">o haz clic para seleccionar</div>
                    <input type="file" class="file-input" id="fileInput" accept=".pdf">
                </div>

                <div class="form-group">
                    <label class="form-label">Título del documento</label>
                    <input type="text" class="form-input" id="docTitle" placeholder="Ej: Manual de Procedimientos 2024">
                </div>

                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <textarea class="form-input form-textarea" id="docDescription" placeholder="Descripción breve del contenido del documento..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Categoría</label>
                    <select class="form-input" id="docCategory">
                        <option value="Manual">Manual</option>
                        <option value="Procedimiento">Procedimiento</option>
                        <option value="Guía">Guía</option>
                        <option value="Política">Política</option>
                        <option value="Técnico">Técnico</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>

                <div>
                    <button class="btn-primary" id="btn-upload">Subir Documento</button>
                    <button class="btn-secondary" id="btn-clear">Limpiar</button>
                </div>
            </div>

            <!-- Biblioteca de Instructivos -->
            <div class="instructivos-library" id="instructivosLibrary">
                <div class="library-header">
                    <h2 style="color: #ff0000; margin-bottom: 1rem;">Biblioteca de Instructivos</h2>
                    <p style="color: #666; margin-bottom: 2rem;">Crea, edita y organiza instructivos técnicos con nuestro editor avanzado</p>
                </div>

                <div class="action-buttons" style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                    <button id="btn-crear-instructivo" class="btn-primary" onclick="window.open('editor-instructivos.html', '_blank')" style="display: flex; align-items: center; gap: 0.5rem;" data-admin-only>
                        Crear Nuevo Instructivo
                    </button>
                    <button id="btn-importar-instructivo" class="btn-secondary" onclick="importarInstructivo()" style="display: flex; align-items: center; gap: 0.5rem;" data-admin-only>
                        Importar Instructivo
                    </button>
                    <button id="btn-exportar-todos" class="btn-secondary" onclick="exportarTodos()" style="display: flex; align-items: center; gap: 0.5rem;" data-admin-only>
                        Exportar Todos
                    </button>
                </div>

                <div class="search-bar">
                    <input type="text" class="search-input" id="searchInput" placeholder="Buscar instructivos por título, categoría o contenido...">
                </div>

                <div class="instructivos-grid" id="instructivosGrid">
                    <!-- Los instructivos aparecerán aquí -->
                </div>

                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">📚</div>
                    <h3>No hay instructivos disponibles</h3>
                    <p>Los instructivos creados aparecerán aquí para su consulta y edición.</p>
                    <button class="btn-primary" onclick="window.open('editor-instructivos.html', '_blank')" style="margin-top: 1rem;" data-admin-only>
                        Crear mi primer instructivo
                    </button>
                </div>

                <!-- Lista de instructivos en el servidor (para admin) -->
                <div id="lista-instructivos-servidor" style="margin-top: 2rem;"></div>
            </div>

            <!-- Visor de Instructivos -->
            <div class="instructivo-viewer" id="instructivoViewer" style="display: none;">
                <div class="viewer-header">
                    <h3 id="viewerTitle">Instructivo</h3>
                    <div class="viewer-actions">
                        <button class="btn-secondary" id="toggleTocBtn" style="margin-right: 1rem; display: none;">Índice</button>
                        <button class="btn-secondary" id="editInstructivoBtn" style="margin-right: 1rem;" data-admin-only>Editar</button>
                        <button class="close-viewer" id="closeViewerBtn">✕ Cerrar</button>
                    </div>
                </div>
                <div class="viewer-body">
                    <!-- Índice de contenido -->
                    <div class="table-of-contents" id="tableOfContents" style="display: none;">
                        <div class="toc-header">
                            <h4>Table of contents</h4>
                            <button class="toc-toggle" id="tocToggle">‹</button>
                        </div>
                        <div class="toc-content" id="tocContent">
                            <!-- Los enlaces se generarán automáticamente -->
                        </div>
                    </div>
                    <!-- Contenido principal -->
                    <div class="instructivo-content" id="instructivoContent">
                        <!-- El contenido del instructivo se mostrará aquí -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para editar imagen de tarjeta -->
    <div class="image-modal" id="imageModal">
        <div class="image-modal-content">
            <h3>Personalizar Imagen de Tarjeta</h3>
            
            <div class="image-info">
                <strong>Recomendaciones:</strong><br>
                • Tamaño óptimo: 300x200 píxeles<br>
                • Formato: PNG, JPG, JPEG o SVG<br>
                • Tamaño máximo: 2MB<br>
                • Para mejor calidad, usa imágenes cuadradas o rectangulares
            </div>

            <div class="image-upload-area" id="imageUploadArea">
                <div id="uploadText">
                    <p><strong>Arrastra una imagen aquí</strong></p>
                    <p>o haz clic para seleccionar</p>
                </div>
                <img class="image-preview" id="imagePreview" alt="Vista previa">
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
            </div>

            <div class="modal-buttons">
                <button class="btn-modal secondary" onclick="closeImageModal()">Cancelar</button>
                <button class="btn-modal secondary" onclick="resetToDefault()">Usar Logo ITC</button>
                <button class="btn-modal primary" onclick="saveCardImage()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="funciones.js"></script>
    <script>
    let currentMode = 'user';

    document.addEventListener('DOMContentLoaded', function() {
        // --- SESIÓN Y USUARIO ---
        function getUsuarioLogueado() {
            const user = sessionStorage.getItem('itc_pedia_user');
            return user ? JSON.parse(user) : null;
        }
        function logout() {
            sessionStorage.removeItem('itc_pedia_user');
            window.location.replace("index.html");
        }
        function actualizarUsuarioNav() {
            const user = getUsuarioLogueado();
            const userInfo = document.getElementById('user-info');
            const logoutBtn = document.getElementById('logout-btn');
            if (user) {
                // Formato más compacto: solo mostrar username y primera letra del rol
                const rolAbrev = user.rol === 'admin' ? 'A' : user.rol.charAt(0).toUpperCase();
                userInfo.textContent = `${user.username}(${rolAbrev})`;
                logoutBtn.style.display = 'inline-block';
            } else {
                userInfo.textContent = '';
                logoutBtn.style.display = 'none';
            }
        }
        actualizarUsuarioNav();
        document.getElementById('logout-btn').addEventListener('click', logout);

        // --- INSTRUCTIVOS ---
        loadInstructivosFromLocalStorage();
        
        // Reparar documentos existentes con problemas de codificación
        if (repairExistingDocuments()) {
            // Si se repararon documentos, recargar desde localStorage
            loadInstructivosFromLocalStorage();
        }
        
        renderInstructivosGrid();

        // --- MODO USUARIO/ADMIN ---
        const user = getUsuarioLogueado();
        setMode(user && user.rol === "admin" ? 'admin' : 'user');

        // --- EVENTOS ---
        const btnUserMode = document.getElementById('btn-user-mode');
        const btnAdminMode = document.getElementById('btn-admin-mode');
        if (btnUserMode) btnUserMode.addEventListener('click', () => setMode('user'));
        if (btnAdminMode) btnAdminMode.addEventListener('click', () => setMode('admin'));

        document.getElementById('uploadArea').addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('uploadArea').addEventListener('dragover', (e) => {
            e.preventDefault();
            document.getElementById('uploadArea').classList.add('dragover');
        });
        document.getElementById('uploadArea').addEventListener('dragleave', () => {
            document.getElementById('uploadArea').classList.remove('dragover');
        });
        document.getElementById('uploadArea').addEventListener('drop', (e) => {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handleFileUpload(files[0]);
            }
        });
        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });
        document.getElementById('btn-upload').addEventListener('click', uploadDocument);
        document.getElementById('btn-clear').addEventListener('click', clearForm);

        // Instructivo Viewer controls
        document.getElementById('closeViewerBtn').addEventListener('click', closeInstructivoViewer);
        document.getElementById('editInstructivoBtn').addEventListener('click', editCurrentInstructivo);

        // Buscar
        document.getElementById('searchInput').addEventListener('input', (e) => {
            filterDocuments(e.target.value);
        });

        // Listar instructivos desde el servidor (solo admin)
        listarInstructivosServidor();
    });

    function setMode(mode) {
        currentMode = mode;
        const adminPanel = document.getElementById('adminPanel');
        const btnUserMode = document.getElementById('btn-user-mode');
        const btnAdminMode = document.getElementById('btn-admin-mode');
        const btnCrearInstructivo = document.getElementById('btn-crear-instructivo');
        const btnImportarInstructivo = document.getElementById('btn-importar-instructivo');
        const btnExportarTodos = document.getElementById('btn-exportar-todos');
        const user = getUsuarioLogueado();

        // Si el usuario NO es admin, fuerza modo usuario y oculta el botón de admin
        if (!user || user.rol !== "admin") {
            currentMode = 'user';
            adminPanel.style.display = 'none';
            btnAdminMode.style.display = 'none';
            btnUserMode.style.display = 'none'; // Oculta también el botón de usuario, ya que no hay alternancia
            btnCrearInstructivo.style.display = 'none'; // Oculta el botón de crear instructivo para usuarios comunes
            btnImportarInstructivo.style.display = 'none'; // Oculta el botón de importar instructivo para usuarios comunes
            btnExportarTodos.style.display = 'none'; // Oculta el botón de exportar todos para usuarios comunes
        } else {
            // Usuario admin: muestra ambos botones y el panel según el modo
            btnAdminMode.style.display = 'inline-block';
            btnUserMode.style.display = 'inline-block';
            adminPanel.style.display = (mode === 'admin') ? 'block' : 'none';
            btnCrearInstructivo.style.display = 'flex'; // Muestra el botón de crear instructivo para administradores
            btnImportarInstructivo.style.display = 'flex'; // Muestra el botón de importar instructivo para administradores
            btnExportarTodos.style.display = 'flex'; // Muestra el botón de exportar todos para administradores
        }

        btnUserMode.classList.toggle('active', currentMode === 'user');
        btnAdminMode.classList.toggle('active', currentMode === 'admin');
        renderInstructivosGrid();
    }

    // Variables globales para instructivos
    let instructivos = [];
    let currentInstructivoId = null;

    // Funciones para manejar instructivos con soporte UTF-8
    function loadInstructivosFromLocalStorage() {
            // Permitir al usuario seleccionar uno o varios archivos JSON desde la carpeta data
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.multiple = true;
            input.onchange = function(e) {
                instructivos = [];
                const files = Array.from(e.target.files);
                let loaded = 0;
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        try {
                            const doc = JSON.parse(ev.target.result);
                            // Normalizar contenido
                            if (doc.title) doc.title = fixWordEncoding(doc.title);
                            if (doc.content) doc.content = fixWordEncoding(doc.content);
                            if (doc.description) doc.description = fixWordEncoding(doc.description);
                            instructivos.push(doc);
                        } catch (error) {
                            console.error('Error al leer archivo:', file.name, error);
                        }
                        loaded++;
                        if (loaded === files.length) {
                            renderInstructivosList();
                        }
                    };
                    reader.readAsText(file);
                });
            };
            input.click();
    }

    function saveInstructivosToLocalStorage() {
        try {
            // Limpiar caracteres antes de guardar
            const cleanedInstructivos = instructivos.map(instructivo => ({
                ...instructivo,
                title: fixWordEncoding(instructivo.title || ''),
                content: fixWordEncoding(instructivo.content || ''),
                description: fixWordEncoding(instructivo.description || '')
            }));
            
            // Asegurar que el JSON se serialice correctamente con UTF-8
            const jsonString = JSON.stringify(cleanedInstructivos);
            localStorage.setItem('itcpedia-documents', jsonString);
        } catch (error) {
            console.error('Error guardando instructivos:', error);
            // Intentar guardar sin normalización como fallback
            localStorage.setItem('itcpedia-documents', JSON.stringify(instructivos));
        }
    }

    // Función para reparar documentos existentes con problemas de codificación
    function repairExistingDocuments() {
        try {
            const saved = localStorage.getItem('itcpedia-documents');
            if (saved) {
                let instructivos = JSON.parse(saved);
                let hasChanges = false;
                
                instructivos = instructivos.map(instructivo => {
                    let updated = { ...instructivo };
                    
                    // Reparar título si contiene caracteres malformados
                    if (updated.title && (updated.title.includes('�') || updated.title.includes('Ã'))) {
                        updated.title = fixWordEncoding(updated.title);
                        hasChanges = true;
                    }
                    
                    // Reparar contenido si contiene caracteres malformados
                    if (updated.content && (updated.content.includes('�') || updated.content.includes('Ã'))) {
                        updated.content = fixWordEncoding(updated.content);
                        hasChanges = true;
                    }
                    
                    // Reparar descripción si contiene caracteres malformados
                    if (updated.description && (updated.description.includes('�') || updated.description.includes('Ã'))) {
                        updated.description = fixWordEncoding(updated.description);
                        hasChanges = true;
                    }
                    
                    return updated;
                });
                
                // Si hubo cambios, guardar los documentos reparados
                if (hasChanges) {
                    localStorage.setItem('itcpedia-documents', JSON.stringify(instructivos));
                    console.log('Documentos reparados y guardados');
                    return true;
                }
            }
        } catch (error) {
            console.error('Error reparando documentos:', error);
        }
        return false;
    }

    function renderInstructivosGrid() {
        const grid = document.getElementById('instructivosGrid');
        const emptyState = document.getElementById('emptyState');
        
        if (instructivos.length === 0) {
            grid.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }
        
        grid.style.display = 'grid';
        emptyState.style.display = 'none';
        
        grid.innerHTML = instructivos.map(instructivo => {
            const wordCount = instructivo.content ? instructivo.content.replace(/<[^>]*>/g, '').split(/\s+/).filter(word => word.length > 0).length : 0;
            const createdDate = new Date(instructivo.created).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            return `
                <div class="instructivo-card" onclick="openInstructivo(${instructivo.id})">
                    ${currentMode === 'admin' ? `
                        <button class="card-edit-icon" onclick="event.stopPropagation(); editCardImage(${instructivo.id})" title="Editar imagen">
                            ✎
                        </button>
                    ` : ''}
                    <div class="instructivo-icon">
                        ${instructivo.customImage ? 
                            `<img src="${instructivo.customImage}" alt="${instructivo.title}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">` :
                            `<img src="media/logotipo_ITC.svg" alt="ITC">`
                        }
                    </div>
                    <div class="instructivo-title">${instructivo.title}</div>
                    <div class="instructivo-badges">
                        ${instructivo.category ? 
                            `<span class="instructivo-category">${instructivo.category}</span>` : 
                            `<span class="instructivo-category empty">Sin categoría</span>`
                        }
                        ${instructivo.group ? 
                            `<span class="instructivo-group">${instructivo.group}</span>` : 
                            `<span class="instructivo-group empty">Sin grupo</span>`
                        }
                    </div>
                    <div class="instructivo-description">${instructivo.description || extractDescription(instructivo.content)}</div>
                    <div class="instructivo-meta">
                        <span class="instructivo-date">${createdDate}</span>
                        <span class="instructivo-words">${wordCount} palabras</span>
                    </div>
                    ${currentMode === 'admin' ? `
                        <div class="admin-controls">
                            <button class="btn-danger" onclick="event.stopPropagation(); deleteInstructivo(${instructivo.id})">Eliminar</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    function extractDescription(content) {
        if (!content) return 'Sin contenido';
        
        // Remover tags HTML y obtener solo texto
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        const textContent = tempDiv.textContent || tempDiv.innerText || '';
        
        // Obtener las primeras palabras como descripción
        const words = textContent.trim().split(/\s+/);
        const description = words.slice(0, 20).join(' ');
        
        return description.length > 100 ? description.substring(0, 100) + '...' : description;
    }

    // Función para limpiar contenido HTML antes de mostrarlo en el visualizador
    function cleanContentForDisplay(htmlContent) {
        if (!htmlContent) return '';
        
        // Crear un elemento temporal para procesar el HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;
        
        // Remover solo párrafos y divs que están completamente vacíos Y no contienen elementos multimedia
        const allElements = tempDiv.querySelectorAll('p, div');
        allElements.forEach(el => {
            const hasMultimedia = el.querySelector('img, video, iframe, audio, canvas, svg');
            const hasText = el.textContent.trim().replace(/\u00a0/g, '').replace(/\s+/g, '');
            const hasOtherContent = el.querySelector('strong, em, a, span, code, pre');
            
            // Solo remover si está completamente vacío Y no tiene multimedia u otro contenido
            if (!hasText && !hasMultimedia && !hasOtherContent) {
                el.remove();
            }
        });
        
        // Limpieza muy conservadora con regex - solo espacios excesivos
        let cleanHTML = tempDiv.innerHTML;
        
        // Solo remover espacios múltiples entre texto, no entre etiquetas
        cleanHTML = cleanHTML
            .replace(/\s{3,}/g, ' ') // Reducir solo espacios muy excesivos
            .trim();
        
        return cleanHTML;
    }

    function openInstructivo(instructivoId) {
        const instructivo = instructivos.find(i => i.id === instructivoId);
        if (!instructivo) return;
        
        currentInstructivoId = instructivoId;
        
        // Limpiar y procesar el contenido antes de mostrarlo
        const cleanContent = cleanContentForDisplay(instructivo.content);
        
        // Actualizar el visor
        document.getElementById('viewerTitle').textContent = instructivo.title;
        document.getElementById('instructivoContent').innerHTML = cleanContent || '<p>Este instructivo no tiene contenido.</p>';
        
        // Limpieza muy conservadora después de insertar el contenido
        setTimeout(() => {
            const contentDiv = document.getElementById('instructivoContent');
            // Solo remover párrafos completamente vacíos que no contengan multimedia
            const emptyPs = contentDiv.querySelectorAll('p');
            emptyPs.forEach(p => {
                const hasContent = p.textContent.trim();
                const hasMultimedia = p.querySelector('img, video, iframe, audio');
                if (!hasContent && !hasMultimedia) {
                    p.remove();
                }
            });
        }, 10);
        
        // Generar y mostrar tabla de contenido
        generateTableOfContents();
        
        // Mostrar el visor y ocultar la biblioteca
        document.getElementById('instructivoViewer').style.display = 'flex';
        document.getElementById('instructivosLibrary').style.display = 'none';
    }

    function closeInstructivoViewer() {
        document.getElementById('instructivoViewer').style.display = 'none';
        document.getElementById('instructivosLibrary').style.display = 'block';
        currentInstructivoId = null;
    }

    function editCurrentInstructivo() {
        // Verificar si el usuario es admin antes de permitir editar
        if (!esAdmin()) {
            alert('Solo los administradores pueden editar instructivos.');
            return;
        }
        
        if (currentInstructivoId) {
            // Abrir el editor con el instructivo específico
            window.open(`editor-instructivos.html?edit=${currentInstructivoId}`, '_blank');
        }
    }

    function deleteInstructivo(instructivoId) {
        // Verificar si el usuario es admin antes de permitir eliminar
        if (!esAdmin()) {
            alert('Solo los administradores pueden eliminar instructivos.');
            return;
        }
        
        if (confirm('¿Estás seguro de que quieres eliminar este instructivo?')) {
            instructivos = instructivos.filter(i => i.id !== instructivoId);
            saveInstructivosToLocalStorage();
            renderInstructivosGrid();
            
            // Si se está viendo el instructivo eliminado, cerrar el visor
            if (currentInstructivoId === instructivoId) {
                closeInstructivoViewer();
            }
        }
    }

    function filterDocuments(searchTerm) {
        const cards = document.querySelectorAll('.instructivo-card');
        const term = searchTerm.toLowerCase();
        
        cards.forEach(card => {
            const title = card.querySelector('.instructivo-title').textContent.toLowerCase();
            const description = card.querySelector('.instructivo-description').textContent.toLowerCase();
            const category = card.querySelector('.instructivo-category').textContent.toLowerCase();
            const group = card.querySelector('.instructivo-group').textContent.toLowerCase();
            
            if (title.includes(term) || description.includes(term) || category.includes(term) || group.includes(term)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Función para limpiar HTML de Word con soporte completo UTF-8
    function cleanWordHTML(html) {
        // Primero corregir la codificación
        html = fixWordEncoding(html);
        
        // Crear elemento temporal
        const temp = document.createElement('div');
        temp.innerHTML = html;
        
        // Convertir entidades HTML a caracteres UTF-8
        html = decodeHTMLEntities(html);
        temp.innerHTML = html;
        
        // Remover comentarios de Word y elementos específicos de Office
        const comments = temp.querySelectorAll('*');
        comments.forEach(el => {
            // Remover atributos de Word
            const attributes = ['class', 'style', 'lang', 'xml:lang', 'o:p', 'w:*'];
            attributes.forEach(attr => {
                if (el.hasAttribute(attr)) {
                    const value = el.getAttribute(attr);
                    if (value && (value.includes('Mso') || value.includes('Word') || value.includes('ms-') || value.includes('Office'))) {
                        el.removeAttribute(attr);
                    }
                }
            });
            
            // Remover elementos específicos de Word
            if (el.tagName && (el.tagName.startsWith('O:') || el.tagName.startsWith('W:'))) {
                el.remove();
            }
        });
        
        // Remover elementos vacíos de Word
        const emptyElements = temp.querySelectorAll('p:empty, span:empty, div:empty, o\\:p');
        emptyElements.forEach(el => el.remove());
        
        // Procesar caracteres especiales y acentos correctamente
        const textNodes = getTextNodes(temp);
        textNodes.forEach(node => {
            if (node.nodeValue) {
                // Aplicar corrección de codificación a cada nodo de texto
                node.nodeValue = fixWordEncoding(node.nodeValue.trim());
            }
        });
        
        // Remover estilos inline innecesarios manteniendo formato básico
        const styledElements = temp.querySelectorAll('[style]');
        styledElements.forEach(el => {
            const style = el.getAttribute('style');
            if (style) {
                // Mantener solo estilos básicos
                const allowedStyles = ['font-weight: bold', 'font-style: italic', 'text-decoration: underline'];
                const cleanStyle = style.split(';')
                    .filter(s => allowedStyles.some(allowed => s.trim().includes(allowed.split(':')[0])))
                    .join(';');
                
                if (cleanStyle) {
                    el.setAttribute('style', cleanStyle);
                } else {
                    el.removeAttribute('style');
                }
            }
        });
        
        // Convertir estilos de Word a HTML semántico
        const boldElements = temp.querySelectorAll('[style*="font-weight"]');
        boldElements.forEach(el => {
            if (el.style.fontWeight === 'bold' || el.style.fontWeight >= 600) {
                const bold = document.createElement('strong');
                bold.innerHTML = el.innerHTML;
                el.parentNode.replaceChild(bold, el);
            }
        });
        
        const italicElements = temp.querySelectorAll('[style*="font-style"]');
        italicElements.forEach(el => {
            if (el.style.fontStyle === 'italic') {
                const italic = document.createElement('em');
                italic.innerHTML = el.innerHTML;
                el.parentNode.replaceChild(italic, el);
            }
        });
        
        // Limpiar espacios excesivos preservando UTF-8
        let cleanHTML = temp.innerHTML;
        cleanHTML = cleanHTML.replace(/\s+/g, ' '); // Múltiples espacios a uno
        cleanHTML = cleanHTML.replace(/<p>\s*<\/p>/g, ''); // Párrafos vacíos
        cleanHTML = cleanHTML.replace(/<br\s*\/?>\s*<br\s*\/?>/g, '</p><p>'); // Dobles BR a párrafos
        
        // Aplicar corrección final de codificación
        cleanHTML = fixWordEncoding(cleanHTML);
        
        // Retornar contenido limpio sin cajas informativas
        const styledContent = `
            <div class="imported-content" style="font-family: 'Roboto', sans-serif; line-height: 1.6; color: #333;">
                ${cleanHTML}
            </div>
        `;
        
        return styledContent;
    }

    // Función de utilidad para reparar manualmente documentos (disponible en consola)
    window.repararDocumentos = function() {
        console.log('Iniciando reparación de documentos...');
        const reparados = repairExistingDocuments();
        if (reparados) {
            loadInstructivosFromLocalStorage();
            renderInstructivosGrid();
            console.log('✅ Documentos reparados exitosamente');
            alert('Documentos reparados exitosamente. Los caracteres especiales ahora deberían verse correctamente.');
        } else {
            console.log('ℹ️ No se encontraron documentos que necesiten reparación');
            alert('No se encontraron documentos que necesiten reparación.');
        }
    };

    // Función auxiliar para decodificar entidades HTML
    function decodeHTMLEntities(text) {
        const textArea = document.createElement('textarea');
        textArea.innerHTML = text;
        return textArea.value;
    }

    // Función auxiliar para obtener todos los nodos de texto
    function getTextNodes(node) {
        let textNodes = [];
        if (node.nodeType === Node.TEXT_NODE) {
            textNodes.push(node);
        } else {
            for (let i = 0; i < node.childNodes.length; i++) {
                textNodes = textNodes.concat(getTextNodes(node.childNodes[i]));
            }
        }
        return textNodes;
    }

    // Función para normalizar caracteres UTF-8 - Versión robusta
    function normalizeUTF8(text) {
        if (!text) return text;
        
        // Primero, intentar normalización estándar
        if (typeof text.normalize === 'function') {
            text = text.normalize('NFC');
        }
        
        // Corregir el símbolo � (U+FFFD) y caracteres malformados comunes
        text = text
            // Reemplazar caracteres de reemplazo
            .replace(/\uFFFD/g, '') // Remover símbolos de reemplazo
            .replace(/�/g, '') // Remover símbolos � visibles
            
            // Corregir codificación doble UTF-8 (muy común en Word)
            .replace(/Ã¡/g, 'á')
            .replace(/Ã©/g, 'é')
            .replace(/Ã­/g, 'í')
            .replace(/Ã³/g, 'ó')
            .replace(/Ãº/g, 'ú')
            .replace(/Ã±/g, 'ñ')
            .replace(/Ã¼/g, 'ü')
            .replace(/Ã§/g, 'ç')
            
            // Mayúsculas
            .replace(/Ã/g, 'Á')
            .replace(/Ã‰/g, 'É')
            .replace(/Ã/g, 'Í')
            .replace(/Ã"/g, 'Ó')
            .replace(/Ãš/g, 'Ú')
            .replace(/Ã'/g, 'Ñ')
            .replace(/Ãœ/g, 'Ü')
            .replace(/Ã‡/g, 'Ç')
            
            // Comillas curvas malformadas
            .replace(/â€œ/g, '"')
            .replace(/â€/g, '"')
            .replace(/â€™/g, "'")
            .replace(/â€˜/g, "'")
            
            // Guiones malformados
            .replace(/â€"/g, '–')
            .replace(/â€"/g, '—')
            .replace(/â€¦/g, '...')
            
            // Espacios especiales malformados
            .replace(/Â /g, ' ')
            .replace(/\u00A0/g, ' ')
            
            // Símbolos comunes malformados
            .replace(/Â©/g, '©')
            .replace(/Â®/g, '®')
            .replace(/â„¢/g, '™')
            .replace(/â‚¬/g, '€')
            .replace(/Â±/g, '±')
            
            // Limpiar secuencias de bytes malformados
            .replace(/[\u0080-\u009F]/g, '') // Controles C1
            .replace(/[\uE000-\uF8FF]/g, '') // Área de uso privado
            .replace(/[\uFFF0-\uFFFF]/g, ''); // Caracteres especiales no válidos
        
        return text;
    }
    
    // Función específica para decodificar texto de Word con problemas de codificación
    function fixWordEncoding(text) {
        if (!text) return text;
        
        // Si detectamos caracteres � o secuencias típicas de Word mal codificado
        if (text.includes('�') || text.includes('Ã') || text.includes('â€')) {
            // Intentar recodificar desde Latin-1 a UTF-8
            try {
                // Crear un array de bytes simulado
                const bytes = [];
                for (let i = 0; i < text.length; i++) {
                    const char = text.charCodeAt(i);
                    if (char <= 0xFF) {
                        bytes.push(char);
                    }
                }
                
                // Intentar decodificar como UTF-8
                if (bytes.length > 0) {
                    const decoder = new TextDecoder('utf-8', { fatal: false });
                    const uint8Array = new Uint8Array(bytes);
                    const decoded = decoder.decode(uint8Array);
                    
                    // Si la decodificación mejoró el texto, usarla
                    if (decoded && !decoded.includes('�') && decoded.length > 0) {
                        text = decoded;
                    }
                }
            } catch (e) {
                // Si falla, continuar con el texto original
                console.warn('Error en recodificación:', e);
            }
        }
        
        return normalizeUTF8(text);
    }

    // Funciones adicionales para importar/exportar
    function importarInstructivo() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,.html,.htm,.txt,.png,.jpg,.jpeg,.gif,.webp';
        input.multiple = true; // Permitir múltiples archivos
        input.onchange = async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            try {
                // Separar archivos por tipo
                const htmlFiles = files.filter(f => f.name.toLowerCase().endsWith('.html') || f.name.toLowerCase().endsWith('.htm'));
                const jsonFiles = files.filter(f => f.name.toLowerCase().endsWith('.json'));
                const txtFiles = files.filter(f => f.name.toLowerCase().endsWith('.txt'));
                const imageFiles = files.filter(f => f.type.startsWith('image/'));
                
                // Procesar cada tipo de archivo
                if (jsonFiles.length > 0) {
                    await processJSONFiles(jsonFiles);
                }
                
                if (htmlFiles.length > 0) {
                    await processHTMLFiles(htmlFiles, imageFiles);
                }
                
                if (txtFiles.length > 0) {
                    await processTXTFiles(txtFiles);
                }
                
                if (htmlFiles.length === 0 && jsonFiles.length === 0 && txtFiles.length === 0) {
                    alert('Por favor, selecciona al menos un archivo válido (.html, .json, .txt).\nLas imágenes deben acompañar a un archivo HTML.');
                }
                
            } catch (error) {
                console.error('Error al importar:', error);
                alert('Error al importar archivos: ' + error.message);
            }
        };
        input.click();
    }

    // Función para convertir imagen a base64
    function convertImageToBase64(imageFile) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                resolve(e.target.result);
            };
            reader.onerror = () => reject(new Error('Error al leer la imagen'));
            reader.readAsDataURL(imageFile);
        });
    }

    // Función para procesar archivos JSON
    async function processJSONFiles(jsonFiles) {
        for (const file of jsonFiles) {
            const content = await readFileAsText(file);
            const jsonData = JSON.parse(content);
            
            if (jsonData.instructivos && Array.isArray(jsonData.instructivos)) {
                // Backup completo
                jsonData.instructivos.forEach(instructivo => {
                    instructivo.id = Date.now() + Math.random();
                    instructivos.unshift(instructivo);
                });
                alert(`Se importaron ${jsonData.instructivos.length} instructivos desde ${file.name}`);
            } else {
                // Instructivo individual
                jsonData.id = Date.now() + Math.random();
                instructivos.unshift(jsonData);
                alert(`Instructivo importado desde ${file.name}`);
            }
        }
        saveInstructivosToLocalStorage();
        renderInstructivosGrid();
    }

    // Función para procesar archivos HTML con imágenes
    async function processHTMLFiles(htmlFiles, imageFiles) {
        for (const htmlFile of htmlFiles) {
            try {
                const htmlContent = await readFileAsText(htmlFile);
                
                // Crear elemento temporal para procesar HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                
                // Convertir imágenes a base64
                const imageMap = new Map();
                for (const imageFile of imageFiles) {
                    const base64 = await convertImageToBase64(imageFile);
                    imageMap.set(imageFile.name, base64);
                }
                
                // Procesar imágenes en el HTML
                const imgElements = tempDiv.querySelectorAll('img');
                let imagesProcessed = 0;
                let imagesMissing = 0;
                
                imgElements.forEach(img => {
                    const src = img.getAttribute('src');
                    if (src) {
                        // Extraer nombre del archivo de la ruta
                        const imageName = src.split('/').pop().split('\\').pop();
                        
                        if (imageMap.has(imageName)) {
                            // Reemplazar src con base64
                            img.setAttribute('src', imageMap.get(imageName));
                            img.setAttribute('data-original-src', src);
                            img.style.maxWidth = '100%';
                            img.style.height = 'auto';
                            img.style.border = '1px solid #ddd';
                            img.style.borderRadius = '4px';
                            img.style.margin = '0.5rem 0';
                            imagesProcessed++;
                        } else {
                            // Marcar imagen faltante
                            img.setAttribute('alt', `[Imagen no encontrada: ${imageName}]`);
                            img.style.border = '2px dashed #ff0000';
                            img.style.padding = '10px';
                            img.style.background = '#ffebee';
                            img.style.color = '#c62828';
                            img.style.textAlign = 'center';
                            img.style.display = 'block';
                            imagesMissing++;
                        }
                    }
                });
                
                // Extraer título
                let title = '';
                const titleElement = tempDiv.querySelector('title');
                const h1Element = tempDiv.querySelector('h1');
                
                if (titleElement && titleElement.textContent.trim()) {
                    title = titleElement.textContent.trim();
                } else if (h1Element && h1Element.textContent.trim()) {
                    title = h1Element.textContent.trim();
                } else {
                    title = htmlFile.name.replace(/\.(html?|htm)$/i, '');
                }
                
                // Extraer contenido del body
                let content = '';
                const bodyElement = tempDiv.querySelector('body');
                if (bodyElement) {
                    content = bodyElement.innerHTML;
                } else {
                    content = tempDiv.innerHTML;
                }
                
                // Limpiar el contenido de Word
                content = cleanWordHTML(content);
                
                // Crear instructivo
                const instructivoData = {
                    id: Date.now() + Math.random(),
                    title: title,
                    content: content,
                    description: extractDescription(content),
                    category: 'Importado',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    source: 'word-html-with-images',
                    imagesProcessed: imagesProcessed,
                    imagesMissing: imagesMissing
                };
                
                instructivos.unshift(instructivoData);
                
                // Mostrar resultado
                let message = `✅ HTML importado: ${title}`;
                if (imagesProcessed > 0) message += `\n${imagesProcessed} imágenes incluidas`;
                if (imagesMissing > 0) message += `\n${imagesMissing} imágenes faltantes`;
                
                alert(message);
                
            } catch (error) {
                alert(`Error procesando ${htmlFile.name}: ${error.message}`);
            }
        }
        
        saveInstructivosToLocalStorage();
        renderInstructivosGrid();
    }

    // Función para procesar archivos de texto
    async function processTXTFiles(txtFiles) {
        for (const file of txtFiles) {
            const textContent = await readFileAsText(file);
            const lines = textContent.split('\n');
            const title = lines[0] || file.name.replace('.txt', '');
            
            // Convertir texto a HTML básico
            const htmlContent = textContent
                .split('\n\n')
                .map(paragraph => paragraph.trim())
                .filter(paragraph => paragraph.length > 0)
                .map(paragraph => `<p>${paragraph.replace(/\n/g, '<br>')}</p>`)
                .join('\n');
            
            const instructivoData = {
                id: Date.now() + Math.random(),
                title: title,
                content: htmlContent,
                description: extractDescription(htmlContent),
                category: 'Importado',
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                source: 'text'
            };
            
            instructivos.unshift(instructivoData);
            alert(`Texto importado: ${title}`);
        }
        
        saveInstructivosToLocalStorage();
        renderInstructivosGrid();
    }

    // Función auxiliar para leer archivos como texto
    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                resolve(e.target.result);
            };
            reader.onerror = () => reject(new Error('Error al leer el archivo'));
            reader.readAsText(file, 'UTF-8');
        });
    }

    function exportarTodos() {
        if (instructivos.length === 0) {
            alert('No hay instructivos para exportar.');
            return;
        }
        
        const exportData = {
            exportDate: new Date().toISOString(),
            version: '1.0',
            instructivos: instructivos
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `instructivos-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // Función para sincronizar con el editor (recargar instructivos cada cierto tiempo)
    function syncWithEditor() {
        loadInstructivosFromLocalStorage();
        renderInstructivosGrid();
    }

    // Sincronizar cada 30 segundos para detectar cambios del editor
    setInterval(syncWithEditor, 30000);

    // Funcionalidad para el panel de administración con extracción real de texto PDF
    async function handleFileUpload(file) {
        if (file.type !== 'application/pdf') {
            alert('Por favor, selecciona un archivo PDF válido.');
            return;
        }
        window.currentFile = file;
        document.querySelector('.upload-text').textContent = `Archivo seleccionado: ${file.name}`;
        
        // Mostrar progreso
        showUploadProgress('Archivo PDF cargado. Listo para procesar...');
    }

    async function uploadDocument() {
        if (!window.currentFile) {
            alert('Por favor, selecciona un archivo PDF primero.');
            return;
        }
        const title = document.getElementById('docTitle').value.trim();
        const description = document.getElementById('docDescription').value.trim();
        const category = document.getElementById('docCategory').value;
        
        if (!title) {
            alert('Por favor, ingresa un título para el documento.');
            return;
        }
        
        try {
            showUploadProgress('Procesando PDF... Esto puede tomar unos momentos.');
            
            // Extraer texto del PDF usando PDF.js
            const pdfText = await extractTextFromPDF(window.currentFile);
            
            showUploadProgress('Convirtiendo a formato instructivo...');
            
            // Convertir el texto extraído en formato instructivo
            const instructivoContent = formatTextAsInstructivo(pdfText, title, description, category);
            
            // Crear el nuevo instructivo
            const newInstructivo = {
                id: Date.now(),
                title: title,
                content: instructivoContent,
                description: description,
                category: category,
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                originalPDF: window.currentFile.name
            };
            
            // Guardar en localStorage
            instructivos.unshift(newInstructivo);
            saveInstructivosToLocalStorage();
            renderInstructivosGrid();
            clearForm();
            
            showUploadProgress('¡Conversión completada exitosamente!');
            setTimeout(() => hideUploadProgress(), 2000);
            
        } catch (error) {
            console.error('Error al procesar PDF:', error);
            alert('Error al procesar el PDF. Por favor, intenta con otro archivo.');
            hideUploadProgress();
        }
    }

    // Función para extraer texto de PDF usando PDF.js
    async function extractTextFromPDF(file) {
        return new Promise((resolve, reject) => {
            const fileReader = new FileReader();
            
            fileReader.onload = async function() {
                try {
                    const typedarray = new Uint8Array(this.result);
                    
                    // Configurar PDF.js
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    
                    // Cargar el PDF
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = '';
                    
                    // Extraer texto de cada página
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        
                        // Procesar elementos de texto
                        const pageText = textContent.items
                            .map(item => item.str)
                            .join(' ')
                            .trim();
                        
                        if (pageText) {
                            fullText += `\n\n=== PÁGINA ${pageNum} ===\n\n${pageText}`;
                        }
                    }
                    
                    resolve(fullText);
                } catch (error) {
                    reject(error);
                }
            };
            
            fileReader.onerror = () => reject(new Error('Error al leer el archivo'));
            fileReader.readAsArrayBuffer(file);
        });
    }

    // Función para formatear el texto extraído como instructivo HTML
    function formatTextAsInstructivo(text, title, description, category) {
        // Limpiar y estructurar el texto
        let content = `<h1>${title}</h1>\n\n`;
        
        if (description) {
            content += `<div class="document-info" style="background: #f8f9fa; padding: 1rem; border-left: 4px solid #ff0000; margin-bottom: 2rem;">
                <p><strong>📋 Descripción:</strong> ${description}</p>
                <p><strong>Categoría:</strong> ${category}</p>
                <p><strong>📅 Convertido:</strong> ${new Date().toLocaleDateString('es-ES')}</p>
            </div>\n\n`;
        }
        
        // Dividir el texto en secciones por páginas
        const pages = text.split('=== PÁGINA');
        
        pages.forEach((page, index) => {
            if (index === 0) return; // Saltar la primera división vacía
            
            const pageContent = page.replace(/^\s*\d+\s*===/, '').trim();
            if (!pageContent) return;
            
            content += `<h2>📄 Página ${index}</h2>\n\n`;
            
            // Procesar el contenido de la página
            const paragraphs = pageContent
                .split(/\n\s*\n/)
                .filter(p => p.trim().length > 0)
                .map(p => p.trim());
            
            paragraphs.forEach(paragraph => {
                // Detectar títulos (líneas más cortas o con patrones específicos)
                if (paragraph.length < 100 && paragraph.match(/^[A-ZÁÉÍÓÚÑ\s\d\.\-:]+$/)) {
                    content += `<h3>${paragraph}</h3>\n\n`;
                } 
                // Detectar listas (líneas que empiezan con números o guiones)
                else if (paragraph.match(/^\s*[\d\-\•]/)) {
                    const listItems = paragraph.split(/\n/).filter(item => item.trim());
                    content += '<ul>\n';
                    listItems.forEach(item => {
                        const cleanItem = item.replace(/^\s*[\d\-\•\.\)]\s*/, '').trim();
                        if (cleanItem) {
                            content += `<li>${cleanItem}</li>\n`;
                        }
                    });
                    content += '</ul>\n\n';
                }
                // Texto normal
                else {
                    content += `<p>${paragraph}</p>\n\n`;
                }
            });
        });
        
        // Agregar nota final
        content += `\n\n<div class="conversion-note" style="background: #e7f3ff; padding: 1rem; border-radius: 4px; border-left: 4px solid #2196f3; margin-top: 2rem;">
            <p><strong>Nota de conversión:</strong> Este instructivo fue generado automáticamente desde un archivo PDF. 
            Puedes editarlo usando el Editor de Instructivos para mejorar el formato, agregar elementos multimedia o reorganizar el contenido.</p>
        </div>`;
        
        return content;
    }

    // Funciones auxiliares para mostrar progreso
    function showUploadProgress(message) {
        let progressDiv = document.getElementById('uploadProgress');
        if (!progressDiv) {
            progressDiv = document.createElement('div');
            progressDiv.id = 'uploadProgress';
            progressDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 2rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                min-width: 300px;
            `;
            document.body.appendChild(progressDiv);
        }
        
        progressDiv.innerHTML = `
            <div style="color: #ff0000; font-size: 2rem; margin-bottom: 1rem;">⏳</div>
            <p style="margin: 0; font-weight: 500;">${message}</p>
            <div style="width: 100%; height: 4px; background: #f0f0f0; border-radius: 2px; margin-top: 1rem; overflow: hidden;">
                <div style="height: 100%; background: linear-gradient(90deg, #ff0000 0%, #b80000 100%); width: 0%; animation: progress 2s ease-in-out infinite;" id="progressBar"></div>
            </div>
        `;
        
        // Agregar animación CSS si no existe
        if (!document.getElementById('progressStyle')) {
            const style = document.createElement('style');
            style.id = 'progressStyle';
            style.textContent = `
                @keyframes progress {
                    0% { width: 0%; }
                    50% { width: 70%; }
                    100% { width: 100%; }
                }
            `;
            document.head.appendChild(style);
        }
    }

    function hideUploadProgress() {
        const progressDiv = document.getElementById('uploadProgress');
        if (progressDiv) {
            progressDiv.remove();
        }
    }

    function clearForm() {
        document.getElementById('docTitle').value = '';
        document.getElementById('docDescription').value = '';
        document.getElementById('docCategory').value = 'Manual';
        document.getElementById('fileInput').value = '';
        document.querySelector('.upload-text').textContent = 'Arrastra tu archivo PDF para convertir a instructivo';
        window.currentFile = null;
    }

    // --- FUNCIONES PARA TABLA DE CONTENIDO ---
    function generateTableOfContents() {
        const content = document.getElementById('instructivoContent');
        const toc = document.getElementById('tableOfContents');
        const tocContent = document.getElementById('tocContent');
        const toggleTocBtn = document.getElementById('toggleTocBtn');
        
        // Buscar todos los encabezados (h1, h2, h3, h4, h5, h6)
        const headers = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
        
        if (headers.length === 0) {
            // Si no hay encabezados, ocultar el índice y el botón
            toc.style.display = 'none';
            toggleTocBtn.style.display = 'none';
            return;
        }
        
        // Mostrar el índice y el botón
        toc.style.display = 'flex';
        
        // Mostrar botón de índice solo en móviles (480px o menos)
        if (window.innerWidth <= 480) {
            toggleTocBtn.style.display = 'inline-block';
        } else {
            toggleTocBtn.style.display = 'none';
        }
        
        // Limpiar contenido anterior
        tocContent.innerHTML = '';
        
        // Generar enlaces para cada encabezado
        headers.forEach((header, index) => {
            // Crear ID único si no existe
            if (!header.id) {
                // Generar ID basado en el texto del título, limpio y sin caracteres especiales
                const cleanText = header.textContent.trim()
                    .toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '')
                    .replace(/\s+/g, '-')
                    .substring(0, 50);
                header.id = cleanText || `heading-${index}`;
            }
            
            // Obtener el nivel del encabezado (1-6)
            const level = parseInt(header.tagName.charAt(1));
            
            // Limpiar el texto del título
            const titleText = header.textContent.trim();
            
            // Saltar encabezados vacíos
            if (!titleText) return;
            
            // Crear el enlace
            const tocItem = document.createElement('a');
            tocItem.href = `#${header.id}`;
            tocItem.className = `toc-item level-${level}`;
            tocItem.textContent = titleText;
            tocItem.title = titleText; // Tooltip para títulos largos
            
            // Agregar evento de clic para scroll suave
            tocItem.addEventListener('click', function(e) {
                e.preventDefault();
                scrollToHeader(header.id);
                setActiveTocItem(tocItem);
                
                // En móviles, ocultar el índice después de seleccionar
                if (window.innerWidth <= 480) {
                    toc.classList.remove('show-mobile');
                }
            });
            
            tocContent.appendChild(tocItem);
        });
        
        // Configurar observador para resaltar el elemento activo
        setupIntersectionObserver(headers);
    }
    
    function scrollToHeader(headerId) {
        const header = document.getElementById(headerId);
        const content = document.getElementById('instructivoContent');
        
        if (header && content) {
            const headerTop = header.offsetTop;
            content.scrollTo({
                top: headerTop - 20,
                behavior: 'smooth'
            });
        }
    }
    
    function setActiveTocItem(activeItem) {
        // Remover clase active de todos los elementos
        const tocItems = document.querySelectorAll('.toc-item');
        tocItems.forEach(item => item.classList.remove('active'));
        
        // Agregar clase active al elemento seleccionado
        if (activeItem) {
            activeItem.classList.add('active');
        }
    }
    
    function setupIntersectionObserver(headers) {
        const content = document.getElementById('instructivoContent');
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const targetId = entry.target.id;
                    const correspondingTocItem = document.querySelector(`.toc-item[href="#${targetId}"]`);
                    if (correspondingTocItem) {
                        setActiveTocItem(correspondingTocItem);
                    }
                }
            });
        }, {
            root: content,
            rootMargin: '-20px 0px -80% 0px',
            threshold: 0
        });
        
        headers.forEach(header => observer.observe(header));
    }
    
    // Agregar eventos para los botones del índice
    document.addEventListener('DOMContentLoaded', function() {
        const tocToggle = document.getElementById('tocToggle');
        const toc = document.getElementById('tableOfContents');
        const toggleTocBtn = document.getElementById('toggleTocBtn');
        
        // Botón de colapsar/expandir en el panel del índice
        if (tocToggle && toc) {
            tocToggle.addEventListener('click', function() {
                toc.classList.toggle('collapsed');
                tocToggle.innerHTML = toc.classList.contains('collapsed') ? '›' : '‹';
            });
        }
        
        // Botón de mostrar/ocultar índice en móviles
        if (toggleTocBtn && toc) {
            toggleTocBtn.addEventListener('click', function() {
                toc.classList.toggle('show-mobile');
                toggleTocBtn.textContent = toc.classList.contains('show-mobile') ? 'Ocultar' : 'Índice';
            });
        }
        
        // Manejar cambios de tamaño de ventana
        window.addEventListener('resize', function() {
            const toggleTocBtn = document.getElementById('toggleTocBtn');
            if (toggleTocBtn) {
                if (window.innerWidth <= 480) {
                    // En móviles, mostrar botón si hay encabezados
                    const headers = document.getElementById('instructivoContent').querySelectorAll('h1, h2, h3, h4, h5, h6');
                    toggleTocBtn.style.display = headers.length > 0 ? 'inline-block' : 'none';
                } else {
                    // En desktop, ocultar botón y restablecer clases
                    toggleTocBtn.style.display = 'none';
                    toc.classList.remove('show-mobile');
                    toggleTocBtn.textContent = 'Índice';
                }
            }
        });
    });

    // --- FUNCIONES PARA IMÁGENES PERSONALIZADAS ---
    let currentEditingCardId = null;
    let selectedImageData = null;

    function editCardImage(instructivoId) {
        currentEditingCardId = instructivoId;
        selectedImageData = null;
        
        // Resetear el modal
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('uploadText').style.display = 'block';
        document.getElementById('imageInput').value = '';
        
        // Mostrar el modal
        document.getElementById('imageModal').style.display = 'flex';
    }

    function closeImageModal() {
        document.getElementById('imageModal').style.display = 'none';
        currentEditingCardId = null;
        selectedImageData = null;
    }

    function resetToDefault() {
        if (currentEditingCardId) {
            const instructivo = instructivos.find(i => i.id === currentEditingCardId);
            if (instructivo) {
                delete instructivo.customImage;
                saveInstructivosToLocalStorage();
                renderInstructivosGrid();
                closeImageModal();
            }
        }
    }

    function saveCardImage() {
        if (currentEditingCardId && selectedImageData) {
            const instructivo = instructivos.find(i => i.id === currentEditingCardId);
            if (instructivo) {
                instructivo.customImage = selectedImageData;
                saveInstructivosToLocalStorage();
                renderInstructivosGrid();
                closeImageModal();
            }
        } else {
            alert('Por favor selecciona una imagen primero.');
        }
    }

    // Configurar eventos del modal
    document.addEventListener('DOMContentLoaded', function() {
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const uploadArea = document.getElementById('imageUploadArea');
        const uploadText = document.getElementById('uploadText');

        // Click en área de upload
        uploadArea.addEventListener('click', function() {
            imageInput.click();
        });

        // Cambio en input de archivo
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                processImageFile(file);
            }
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function() {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    processImageFile(file);
                } else {
                    alert('Por favor selecciona un archivo de imagen válido.');
                }
            }
        });

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('imageModal').style.display === 'flex') {
                closeImageModal();
            }
        });

        // Cerrar modal al hacer click fuera
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });
    });

    function processImageFile(file) {
        // Validar tipo de archivo
        if (!file.type.startsWith('image/')) {
            alert('Por favor selecciona un archivo de imagen válido.');
            return;
        }

        // Validar tamaño (2MB máximo)
        if (file.size > 2 * 1024 * 1024) {
            alert('La imagen es demasiado grande. El tamaño máximo es 2MB.');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const imageData = e.target.result;
            
            // Crear imagen para verificar dimensiones
            const img = new Image();
            img.onload = function() {
                // Mostrar vista previa
                const preview = document.getElementById('imagePreview');
                const uploadText = document.getElementById('uploadText');
                
                preview.src = imageData;
                preview.style.display = 'block';
                uploadText.style.display = 'none';
                
                // Guardar datos de la imagen
                selectedImageData = imageData;
                
                // Mostrar información de la imagen
                const info = document.querySelector('.image-info');
                info.innerHTML = `
                    <strong>Imagen seleccionada:</strong><br>
                    • Nombre: ${file.name}<br>
                    • Dimensiones: ${img.width}x${img.height} píxeles<br>
                    • Tamaño: ${(file.size / 1024).toFixed(1)} KB<br>
                    • Formato: ${file.type}<br><br>
                    <strong>Recomendación:</strong> Para mejor calidad, usa imágenes de 300x200 píxeles
                `;
            };
            img.src = imageData;
        };
        reader.readAsDataURL(file);
    }

    // --- LISTAR INSTRUCTIVOS DESDE EL SERVIDOR ---
    function listarInstructivosServidor() {
        fetch('data/listar-instructivos.php')
            .then(response => response.json())
            .then(lista => {
                const listaEl = document.getElementById('lista-instructivos-servidor');
                listaEl.innerHTML = '';
                lista.forEach(item => {
                    const btn = document.createElement('button');
                    btn.textContent = item.title + ' (' + item.modified.substring(0, 10) + ')';
                    btn.onclick = function() {
                        cargarInstructivoServidor(item.file);
                    };
                    listaEl.appendChild(btn);
                });
            });
    }

    function cargarInstructivoServidor(nombreArchivo) {
        fetch('data/' + nombreArchivo)
            .then(response => response.json())
            .then(doc => {
                mostrarInstructivo(doc);
            })
            .catch(error => {
                alert('Error al cargar instructivo: ' + error);
            });
    }

    function mostrarInstructivo(doc) {
        // Aquí debes adaptar según tu estructura de visualización
        document.getElementById('titulo-instructivo').textContent = doc.title || '';
        document.getElementById('contenido-instructivo').innerHTML = doc.content || '';
        // ...otros campos si los tienes
    }

    // Llama listarInstructivosServidor() al cargar la página
    window.onload = listarInstructivosServidor;
    </script>
</body>
</html>